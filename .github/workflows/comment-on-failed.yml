name: Comment on failed linting

on:
  workflow_run:
    workflows: ["linter-bot-comment"]
    types:
      - completed
    
jobs:
  comment:
    if: ${{ github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
        - run: echo '${{ toJson(github.event.workflow_run) }}'
        - name: "Get information about the origin 'CI' run"
          uses: potiuk/get-workflow-origin@v1_5
          id: source-run-info
          with:
            token: ${{ secrets.GITHUB_TOKEN }}
            sourceRunId: ${{ github.event.workflow_run.id }}
        - name: Fetch output from other workflow
          uses: actions/github-script@v6
          with:
              github-token: ${{ secrets.GITHUB_TOKEN }}
              script: |
                const workflowId = ${{ github.event.workflow_run.id }};
                const jobName = 'lint';
                const runId = context.payload.workflow_run.id;
                const { data } = await github.rest.actions.getWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: runId,
                });
                console.log(JSON.stringify(data, null, 2));
        - name: Download artifact
          id: download-artifact
          uses: dawidd6/action-download-artifact@v2
          with:
            run_id: ${{ github.event.workflow_run.id }}
            name: lint-log
        - name: Show Logs
          id: show-logs
          run: |
            ls -la lint-log
        - name: Comment on pull request
          uses: actions/github-script@v6
          with:
              github-token: ${{secrets.GITHUB_TOKEN}}
              script: |
                const failedJobs = '${{ github.event.workflow_run.jobs.lint.outputs }}';
                let message = `Linter is failing on your pull request. Please enable pre-commit hooks (info under this link: ...) \n\n`;
                if (failedJobs.includes('isort')) {
                    message += `For the issue with isort, you can run:\n\n\`isort .\`\n\nAnd then commit the changes:\n\n\`git commit -am "ran isort"\`\n\`git push\`\n`;
                }
                if (failedJobs.includes('black')) {
                    message += `For the issue with black, you can run:\n\n\`black .\`\n\nAnd then commit the changes:\n\n\`git commit -am "ran black"\`\n\`git push\`\n`;
                }
                github.rest.issues.createComment({
                    issue_number: '${{ steps.source-run-info.outputs.pullRequestNumber }}',
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: message,
                })
    